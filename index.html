<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Mini AI Chat</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
<div id="loader">
    <p>â³ Downloading AI model... please wait!</p>
    <progress id="loadProgress" max="100" value="0"></progress>
    <p style="margin-top: 10px; font-size: 0.9em; color: gray;">
        This may take 30â€“60 seconds. First load is slow but cached forever ğŸ’–
    </p>
</div>

<div id="chatContainer" style="display:none;">
    <div id="chatBox"></div>
    <div id="inputArea">
        <input type="text" id="userInput" placeholder="Type your message..." />
        <button id="sendBtn">Send</button>
    </div>
</div>

<!-- âœ… Load WebLLM from CDN -->
<script type="module">
    import { CreateMLCEngine } from "https://esm.run/@mlc-ai/web-llm";

    const loader = document.getElementById("loader");
    const chatUI = document.getElementById("chatContainer");
    const progressBar = document.getElementById("loadProgress");
    const sendBtn = document.getElementById("sendBtn");
    const userInput = document.getElementById("userInput");
    const chatBox = document.getElementById("chatBox");

    let engine;

    async function initAI() {
        const model = "Llama-3.2-1B-Instruct-q4f32_1-MLC"; // âœ… Valid prebuilt model name

        const initProgressCallback = (percent) => {
            progressBar.value = Math.floor(percent * 100);
        };

        try {
            engine = await CreateMLCEngine(model, {
                initProgressCallback,
            });
        } catch (err) {
            alert("WebGPU is not supported on this browser ğŸ˜¢.\nTry Chrome 113+ or Safari TP.");
            throw err;
        }

        loader.style.display = "none";
        chatUI.style.display = "flex";
    }

    sendBtn.onclick = async () => {
        const input = userInput.value.trim();
        if (!input) return;

        appendMessage("ğŸ‘¤", input);
        userInput.value = "";

        appendMessage("ğŸ¤–", "...thinking");

        const messages = [
            { role: "system", content: "You are a helpful assistant." },
            { role: "user", content: input },
        ];

        const reply = await engine.chat.completions.create({
            messages,
        });

        updateLastMessage("ğŸ¤–", reply.choices[0].message.content);
    };

    function appendMessage(who, text) {
        const msgDiv = document.createElement("div");
        msgDiv.textContent = `${who}: ${text}`;
        chatBox.appendChild(msgDiv);
        chatBox.scrollTop = chatBox.scrollHeight;
    }

    function updateLastMessage(who, text) {
        const last = chatBox.lastChild;
        last.textContent = `${who}: ${text}`;
        chatBox.scrollTop = chatBox.scrollHeight;
    }

    initAI();
</script>
</body>
</html>
